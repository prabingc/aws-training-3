pipeline {
    agent any
    environment {
    jenkin_cred = credentials('jenkins_call') // Reference the credentials ID
    }
    stages {
        stage('Create new pipelines') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'jenkins_call', usernameVariable: 'JENKINS_USER', passwordVariable: 'JENKINS_TOKEN')]) {
                sh '''
                    curl -O http://localhost:8080/jnlpJars/jenkins-cli.jar
                    java -jar jenkins-cli.jar -s http://localhost:8080  -auth "$JENKINS_USER:$JENKINS_TOKEN" create-job build_images < docker_build.xml
                '''
                    }
                }
        }
        stage('Load Shared Vars') {
            steps {
                script {
                def vars = load 'vars/sharedVars.groovy'
                env.AWS_REGION = vars.AWS_REGION
                env.CLUSTER_NAME = vars.CLUSTER_NAME
                }
            }
            }  
        stage('Create EKS Cluster') {
                    steps {
                        script {
                            withAWS(credentials: 'aws-creds', region: env.AWS_REGION) {
                                sh """
                                export CLUSTER_NAME=${CLUSTER_NAME}
                                envsubst < cluster_definition.yaml > processed.yaml
                                eksctl create cluster -f processed.yaml
                                """
                            }
                        }
                    }
                }
            }
    }