pipeline {
    agent {
        kubernetes {
            label 'jenkins-agent'
            defaultContainer 'jnlp' // must match container name in pod template
        }
    }

    environment {
        AWS_REGION = 'us-east-2'
        CLUSTER_NAME = 'prabin-eks'
    }

    stages {
        stage('Configure Kubeconfig') {
            steps {
                withAWS(credentials: 'aws-creds', region: "${AWS_REGION}") {
                    sh """
                        aws eks update-kubeconfig --name ${CLUSTER_NAME} --region ${AWS_REGION}
                    """
                }
            }
        }

        stage('Deploy Pod to EKS') {
            steps {
                script {
                    def podManifest = """
                    apiVersion: v1
                    kind: Pod
                    metadata:
                      name: nginx-pod
                    spec:
                      containers:
                      - name: nginx
                        image: nginx:latest
                        ports:
                        - containerPort: 80
                    """

                    writeFile file: 'nginx-pod.yaml', text: podManifest
                    container('jnlp') {
                    sh 'kubectl apply -f nginx-pod.yaml'}
                }
            }
        }
    }
}